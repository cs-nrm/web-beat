---
const PLACEHOLDER_IMG = 'https://storage.googleapis.com/nrm-web/beat/resources/img/img_beat-min.jpg';
import { formatFecha, parseToDate, formatHora } from '../lib/formatters.js';


export async function getQuePlanPosts({ per_page = 80, category = 818 } = {}){
  const url = `https://beatdigital.com.mx/wp-json/wp/v2/posts?_embed&per_page=${per_page}&_fields=title,slug,content,acf,yoast_head_json,_links,_embedded&categories=${category}&filter[orderby]=acf[inicio]&order=asc`;
  const res = await fetch(url);
  if(!res.ok) return [];
  let posts = await res.json();

  // Sort by hora_inicio if present
  posts.sort(function(a,b){
    const ah = a?.acf?.hora_inicio || '';
    const bh = b?.acf?.hora_inicio || '';
    return ah > bh ? 1 : (ah < bh ? -1 : 0);
  });

  // add formatted dates
  posts.forEach(p => {
    p.fecha_inicio_formateada = formatFecha(p.acf?.fecha_inicio || p.acf?.fecha_inicio_raw || p.fecha_inicio || '');
    p.fecha_fin_formateada = formatFecha(p.acf?.fecha_fin || p.acf?.fecha_fin_raw || p.fecha_fin || '');
  });

  // filter out expired
  const today = new Date();
  today.setHours(0,0,0,0);
  posts = posts.filter(p => {
    const raw = p.acf?.fecha_fin || p.acf?.fecha_inicio || '';
    if(!raw) return true;
    const d = parseToDate(raw);
    if(!d) return true;
    d.setHours(0,0,0,0);
    return d >= today;
  });

  return posts;
}

const posts = await getQuePlanPosts();
---
<div class="main-carousel container cards slider-destacados-plan">
  	{
  	posts.map((post:any) => (
		post.acf?.destacada === true &&
		<div class="carousel-cell card">
		<article class="p-2">
			<div class="glows"></div>
			<a href={`/que-plan/${post.slug}/`} class="text-white relative">
				<div class="bg-white text-black text-sm absolute top-0 right-0 px-2 etiqueta" set:html={post.acf?.etiqueta}></div>
				<div>
					<img class="block h-auto w-full object-fill" src={post?._embedded?.['wp:featuredmedia']?.[0]?.media_details?.sizes?.['full']?.source_url || PLACEHOLDER_IMG} width="200" height="200" alt="Imagen Locutores"/>
				</div>
				<div class="min-h-40">
					<h3 class="mt-4 mb-2 text-lg font-bold text-white text-podcast" set:html={post.title.rendered}></h3>
					<div class="flex items-center gap-4 text-sm mb-2">
						<div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11a3 3 0 1 0 6 0a3 3 0 0 0 -6 0" /><path d="M17.657 16.657l-4.243 4.243a2 2 0 0 1 -2.827 0l-4.244 -4.243a8 8 0 1 1 11.314 0z" /></svg></div>
						<div class="leading-none"><span set:html={post.acf?.lugar}></span><span>, </span><span set:html={post.acf?.ciudad}></span></div>
					</div>
					<div class="flex items-center gap-4 text-sm mb-2">
						<div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M4 7a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12z" /><path d="M16 3v4" /><path d="M8 3v4" /><path d="M4 11h16" /><path d="M11 15h1" /><path d="M12 15v3" /></svg></div>
						<span set:html={post.fecha_inicio_formateada}></span>
						{post.acf.fecha_fin && <span> - <span set:html={post.fecha_fin_formateada}></span></span> }
					</div>
					<div class="flex items-center gap-4 text-sm mb-2">
						<div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="20" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /></svg></div>
						<span>{formatHora(post.acf?.hora)} hrs.</span>
					</div>
				</div>
				
			</a>
		</article>
		</div>
  	))
  	}
</div>

<style>	

.carousel-cell img{
    box-shadow: none;
    -webkit-mask-image: linear-gradient(to bottom, hsla(var(--color-black), 1) 0, hsla(var(--color-black), 1) 70%, hsla(var(--color-black), 0) 100%);
    mask-image: linear-gradient(to bottom, hsla(var(--color-black), 1) 0, hsla(var(--color-black), 1) 70%, hsla(var(--color-black), 0) 100%);
}
.carousel-cell {
  width: 286px;
  margin-right: 40px;
  border-radius: 20px;
  padding: 10px;
  margin-top: 20px;
}

.text-podcast{
	display: -webkit-box;
	-webkit-margin-before: 0;
    margin-block-start: 0;
    -webkit-margin-after: 12px;
    margin-block-end: 12px;
    line-height: 1.2;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
</style>
